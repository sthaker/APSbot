<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Acute Pain Service DSS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    .rec-card { transition: all 0.15s; }
    .rec-card:hover { transform: translateY(-1px); }
    .math-block { font-family: 'SF Mono', 'Fira Code', monospace; font-size: 0.75rem; background: #f1f5f9; padding: 0.5rem; border-radius: 4px; margin-top: 0.25rem; white-space: pre-wrap; }
    .badge { display: inline-flex; align-items: center; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.625rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
    .section-label { font-size: 0.625rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: #64748b; margin-bottom: 0.5rem; }
    @media print { .no-print { display: none !important; } }
  </style>
</head>
<body>
  <div id="app-container">
    <div id="root"></div>
  </div>

  <script type="text/babel">
    // SVG Icon Components
    const ChevronDown = ({ size = 24, className = '' }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="6 9 12 15 18 9"></polyline></svg>
    );
    const ChevronUp = ({ size = 24, className = '' }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="18 15 12 9 6 15"></polyline></svg>
    );
    const X = ({ size = 24, className = '' }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    );
    const Copy = ({ size = 24, className = '' }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
    );

    // ========== MEDD CONVERSION ENGINE ==========
    // Factors: multiply (dose × factor × doses_per_day) = daily OME
    // All oral morphine equivalents per mg (or mcg for fentanyl)
    const MEDD_FACTORS = {
      // IV Opioids
      'Morphine IV': 3,
      'Hydromorphone IV': 20,
      'Fentanyl IV': 0.3,        // per mcg: 100mcg fentanyl IV = 30 OME ≈ morphine IV 10mg
      'Ketorolac IV': 0,
      'Ketamine IV': 0,
      'Methadone IV': null,       // non-linear, handled separately
      // PO Opioids
      'Morphine IR': 1,
      'Morphine ER': 1,
      'Morphine PO': 1,          // alias
      'Oxycodone IR': 1.5,
      'Oxycodone ER': 1.5,
      'Oxycodone PO': 1.5,       // alias
      'Hydromorphone PO': 4,
      'Hydrocodone/APAP': 1,
      'Tramadol': 0.1,
      'Codeine': 0.15,
      'Methadone PO': null,       // non-linear
      'Oxymorphone': 3,
      'Tapentadol': 0.4,
      'Ketamine PO': 0,
      // Other routes
      'Fentanyl Patch': 2.4,      // per mcg/hr: 25mcg/hr = 60 OME/day (conservative)
      'Buprenorphine SL': null,
      'Buprenorphine Patch': null,
      'Buprenorphine Injection': null,
      'Suzetrigine': 0,
    };

    // PCA drugs → their IV MEDD factors
    const PCA_FACTORS = {
      'Hydromorphone': 20,   // mg → OME (IV)
      'Morphine': 3,         // mg → OME (IV)
      'Fentanyl': 0.3,       // mcg → OME (IV)
    };

    const frequencyToDaily = (frequency) => {
      const map = {
        PRN: 0.5,
        'Q2H PRN': 6, Q2H: 12,
        'Q3H PRN': 4, Q3H: 8,
        'Q4H PRN': 3, Q4H: 6,
        'Q6H PRN': 2, Q6H: 4,
        'Q8H': 3, 'Q8H PRN': 1.5,
        Q12H: 2, Q24H: 1, Q72H: 0.33,
        Continuous: 24,
      };
      return map[frequency] || 1;
    };

    // Methadone: non-linear conversion. Thresholds based on daily OME equivalent.
    // Returns methadone→OME factor (multiply methadone mg × factor = OME)
    // At low doses methadone is ~4:1 (morphine:methadone), at high doses ~12:1
    const getMethadoneMEDDFactor = (dailyMethadoneMg) => {
      // Approximate: reverse-engineer OME from methadone dose
      // These are clinically derived approximations
      if (dailyMethadoneMg <= 10) return 4;    // methadone ≤10mg/day ≈ OME ≤40
      if (dailyMethadoneMg <= 20) return 5;    // methadone 11-20 ≈ OME 55-100
      if (dailyMethadoneMg <= 40) return 8;    // methadone 21-40 ≈ OME 168-320
      if (dailyMethadoneMg <= 60) return 10;   // methadone 41-60 ≈ OME 410-600
      return 12;                                // methadone >60 ≈ OME >720
    };

    const calculateMEDD = (opioids, pca) => {
      let totalMEDD = 0;
      const breakdown = [];

      opioids.forEach((med) => {
        const { drug, dose, frequency } = med;
        if (!dose) return;
        let baseDose = parseFloat(dose);
        let factor = MEDD_FACTORS[drug];
        let dailyDoses = frequencyToDaily(frequency);
        let contribution = 0;

        if (drug === 'Methadone PO' || drug === 'Methadone IV') {
          const dailyDose = baseDose * dailyDoses;
          factor = getMethadoneMEDDFactor(dailyDose);
          contribution = dailyDose * factor;
          breakdown.push({ drug, dose: baseDose, freq: frequency, factor: `${factor} (non-linear)`, daily: dailyDose, ome: Math.round(contribution) });
        } else if (drug === 'Fentanyl Patch') {
          // Patch: strength in mcg/hr, applied Q72H. OME = mcg × 2.4 per day
          contribution = baseDose * 2.4;
          breakdown.push({ drug, dose: baseDose, freq: 'Q72H', factor: '2.4/day', daily: baseDose, ome: Math.round(contribution) });
        } else if (factor === null || factor === undefined) {
          // Buprenorphine, etc. — don't contribute to MEDD in standard way
          breakdown.push({ drug, dose: baseDose, freq: frequency, factor: 'N/A', daily: 0, ome: 0, note: 'Excluded from MEDD' });
        } else if (factor === 0) {
          // Non-opioids in the list (ketorolac, ketamine, suzetrigine)
        } else {
          contribution = baseDose * factor * dailyDoses;
          breakdown.push({ drug, dose: baseDose, freq: frequency, factor, daily: baseDose * dailyDoses, ome: Math.round(contribution) });
        }
        totalMEDD += contribution;
      });

      // PCA contribution
      let pcaContribution = 0;
      let pcaDetail = null;
      if (pca.active && pca.drug) {
        const demandDose = parseFloat(pca.demandDose) || 0;
        const lockout = parseFloat(pca.lockout) || 6;
        const basalRate = parseFloat(pca.basalRate) || 0;
        const pcaFactor = PCA_FACTORS[pca.drug] || 1;

        const maxDemandsPerHr = 60 / lockout;
        const estimatedDailyDemand = demandDose * maxDemandsPerHr * 24 * 0.3;
        const estimatedDailyBasal = basalRate * 24;
        const totalDailyDose = estimatedDailyDemand + estimatedDailyBasal;

        pcaContribution = totalDailyDose * pcaFactor;
        pcaDetail = {
          drug: pca.drug,
          demand: demandDose,
          lockout,
          basal: basalRate,
          estDaily: Math.round(totalDailyDose * 10) / 10,
          factor: pcaFactor,
          ome: Math.round(pcaContribution),
          note: `30% demand utilization assumed (${Math.round(estimatedDailyDemand * 10) / 10} demand + ${estimatedDailyBasal} basal = ${Math.round(totalDailyDose * 10) / 10} ${pca.drug === 'Fentanyl' ? 'mcg' : 'mg'}/day)`,
        };
        totalMEDD += pcaContribution;
      }

      return { total: Math.round(totalMEDD), breakdown, pcaDetail };
    };

    const calculateEquianalgesicDose = (sourceDrug, sourceDose, sourceFrequency, targetDrug, crossToleranceReduction = 0.25) => {
      const sourceFactor = MEDD_FACTORS[sourceDrug];
      const targetFactor = MEDD_FACTORS[targetDrug];
      if (!sourceFactor || !targetFactor || targetFactor === 0) return null;

      const perDoseOME = sourceDose * sourceFactor;
      const equiPerDose = perDoseOME / targetFactor;
      const adjusted = equiPerDose * (1 - crossToleranceReduction);

      return {
        perDoseOME: Math.round(perDoseOME * 10) / 10,
        equianalgesic: Math.round(equiPerDose * 10) / 10,
        adjusted: Math.round(adjusted * 10) / 10,
        math: `${sourceDrug} ${sourceDose}${sourceDrug.includes('Fentanyl') ? 'mcg' : 'mg'} × ${sourceFactor} = ${Math.round(perDoseOME * 10) / 10} OME/dose → ÷ ${targetFactor} = ${Math.round(equiPerDose * 10) / 10}mg → −25% cross-tolerance = ${Math.round(adjusted * 10) / 10}mg`,
      };
    };

    // Round to practical clinical doses
    const roundToClinic = (dose, drug) => {
      if (drug.includes('Hydromorphone') && drug.includes('IV')) {
        return Math.round(dose * 5) / 5; // round to 0.2mg
      }
      if (drug.includes('Fentanyl')) return Math.round(dose / 25) * 25; // round to 25mcg
      if (dose < 2) return Math.round(dose * 10) / 10; // round to 0.1
      if (dose < 10) return Math.round(dose * 2) / 2; // round to 0.5
      return Math.round(dose / 2.5) * 2.5; // round to 2.5mg
    };

    // ========== MAIN APP ==========
    const AcutePainDSS = () => {
      // Context
      const [consultTypes, setConsultTypes] = React.useState([]);
      const [primaryCondition, setPrimaryCondition] = React.useState('');
      const [postOpDay, setPostOpDay] = React.useState('');
      const [toleratingPO, setToleratingPO] = React.useState(true);

      // Pain Assessment
      const [painAtRest, setPainAtRest] = React.useState(5);
      const [painWithActivity, setPainWithActivity] = React.useState(5);
      const [painQuality, setPainQuality] = React.useState([]);
      const [controlStatus, setControlStatus] = React.useState('Partial');
      const [painPattern, setPainPattern] = React.useState('Constant');

      // Medications
      const [opioids, setOpioids] = React.useState([]);
      const [nonOpioids, setNonOpioids] = React.useState({});
      const [infusions, setInfusions] = React.useState({});
      const [pca, setPCA] = React.useState({ active: false, drug: 'Hydromorphone', demandDose: '', lockout: '6', basalRate: '' });

      // Selected opioid for inline form
      const [selectedOpioidButton, setSelectedOpioidButton] = React.useState(null);
      const [opioidFormDose, setOpioidFormDose] = React.useState('');
      const [opioidFormFreq, setOpioidFormFreq] = React.useState('Q4H');
      const [opioidFormUnit, setOpioidFormUnit] = React.useState('mg');

      // Patient Factors
      const [toleranceStatus, setToleranceStatus] = React.useState('naive');
      const [homeOME, setHomeOME] = React.useState('');
      const [hasOUD, setHasOUD] = React.useState(false);
      const [moud, setMoud] = React.useState({});
      const [comorbidities, setComorbidities] = React.useState([]);
      const [sedationStatus, setSedationStatus] = React.useState('Alert');
      const [onMonitoring, setOnMonitoring] = React.useState(false);
      const [weight, setWeight] = React.useState('');

      // UI State
      const [activeTab, setActiveTab] = React.useState('input');
      const [expandedInputSections, setExpandedInputSections] = React.useState({
        context: true, pain: true, meds: true, factors: true,
      });
      const [showMEDDBreakdown, setShowMEDDBreakdown] = React.useState(false);
      const [copiedNote, setCopiedNote] = React.useState(false);

      const meddResult = React.useMemo(() => calculateMEDD(opioids, pca), [opioids, pca]);
      const medd = meddResult.total;

      const resetAll = () => {
        setConsultTypes([]); setPrimaryCondition(''); setPostOpDay('');
        setPainAtRest(5); setPainWithActivity(5); setPainQuality([]);
        setControlStatus('Partial'); setPainPattern('Constant');
        setOpioids([]); setNonOpioids({}); setInfusions({});
        setPCA({ active: false, drug: 'Hydromorphone', demandDose: '', lockout: '6', basalRate: '' });
        setSelectedOpioidButton(null); setOpioidFormDose(''); setOpioidFormFreq('Q4H'); setOpioidFormUnit('mg');
        setToleranceStatus('naive'); setHomeOME(''); setHasOUD(false); setMoud({});
        setComorbidities([]); setSedationStatus('Alert'); setToleratingPO(true);
        setOnMonitoring(false); setWeight('');
      };

      // Drug definitions
      const ivOpioids = [
        { name: 'Morphine IV', unit: 'mg' },
        { name: 'Hydromorphone IV', unit: 'mg' },
        { name: 'Fentanyl IV', unit: 'mcg' },
        { name: 'Ketorolac IV', unit: 'mg' },
        { name: 'Ketamine IV', unit: 'mg' },
        { name: 'Methadone IV', unit: 'mg' },
      ];

      const poOpioids = [
        { name: 'Morphine IR', unit: 'mg' },
        { name: 'Morphine ER', unit: 'mg' },
        { name: 'Oxycodone IR', unit: 'mg' },
        { name: 'Oxycodone ER', unit: 'mg' },
        { name: 'Hydromorphone PO', unit: 'mg' },
        { name: 'Hydrocodone/APAP', unit: 'mg' },
        { name: 'Tramadol', unit: 'mg' },
        { name: 'Codeine', unit: 'mg' },
        { name: 'Methadone PO', unit: 'mg' },
        { name: 'Oxymorphone', unit: 'mg' },
        { name: 'Tapentadol', unit: 'mg' },
        { name: 'Ketamine PO', unit: 'mg' },
      ];

      const otherRouteOpioids = [
        { name: 'Fentanyl Patch', unit: 'mcg/hr' },
        { name: 'Buprenorphine SL', unit: 'mg' },
        { name: 'Buprenorphine Patch', unit: 'mcg/hr' },
        { name: 'Buprenorphine Injection', unit: 'mg' },
      ];

      const nonOpioidDrugs = [
        { name: 'Acetaminophen', hasDose: true, defaultDose: '650' },
        { name: 'Ibuprofen', hasDose: false },
        { name: 'Celecoxib', hasDose: false },
        { name: 'Naproxen', hasDose: false },
        { name: 'Gabapentin', hasDose: true, defaultDose: '300' },
        { name: 'Pregabalin', hasDose: true, defaultDose: '75' },
        { name: 'Duloxetine', hasDose: false },
        { name: 'Amitriptyline', hasDose: true, defaultDose: '10' },
        { name: 'Nortriptyline', hasDose: true, defaultDose: '10' },
        { name: 'Cyclobenzaprine', hasDose: false },
        { name: 'Methocarbamol', hasDose: false },
        { name: 'Baclofen', hasDose: true, defaultDose: '5' },
        { name: 'Tizanidine', hasDose: true, defaultDose: '2' },
        { name: 'Lidocaine patch 5%', hasDose: false },
        { name: 'Topical diclofenac', hasDose: false },
        { name: 'Suzetrigine', hasDose: true, defaultDose: '100' },
      ];

      const infusionDrugs = [
        'Ketamine infusion', 'Lidocaine IV infusion', 'Epidural',
        'Peripheral nerve block (single shot)', 'Continuous nerve block catheter', 'Dexmedetomidine',
      ];

      const frequencyOptions = ['PRN', 'Q2H PRN', 'Q2H', 'Q3H PRN', 'Q3H', 'Q4H PRN', 'Q4H', 'Q6H PRN', 'Q6H', 'Q8H PRN', 'Q8H', 'Q12H', 'Q24H', 'Q72H', 'Continuous'];
      const qualityOptions = ['Aching/Throbbing', 'Burning/Shooting', 'Cramping/Colicky', 'Sharp/Stabbing', 'Dull/Pressure'];

      // Handlers
      const toggleInputSection = (section) => {
        setExpandedInputSections((prev) => ({ ...prev, [section]: !prev[section] }));
      };
      const toggleConsultType = (type) => {
        if (consultTypes.includes(type)) setConsultTypes(consultTypes.filter(t => t !== type));
        else setConsultTypes([...consultTypes, type]);
      };

      const addOpioidFromButton = (drugObj) => {
        if (opioidFormDose) {
          const defaultFreq = drugObj.name === 'Fentanyl Patch' ? 'Q72H' : drugObj.name.includes('IV') ? 'Q4H PRN' : 'Q4H';
          setOpioids([...opioids, { drug: drugObj.name, dose: opioidFormDose, frequency: opioidFormFreq || defaultFreq, unit: drugObj.unit }]);
          setOpioidFormDose('');
          setOpioidFormFreq(selectedOpioidButton?.includes('IV') ? 'Q4H PRN' : 'Q4H');
          setOpioidFormUnit('mg');
          setSelectedOpioidButton(null);
        }
      };

      const removeOpioid = (index) => setOpioids(opioids.filter((_, i) => i !== index));

      const toggleNonOpioid = (drugName) => {
        if (nonOpioids[drugName]) {
          const copy = { ...nonOpioids }; delete copy[drugName]; setNonOpioids(copy);
        } else {
          setNonOpioids({ ...nonOpioids, [drugName]: { active: true, dose: '', scheduled: false } });
        }
      };

      const toggleInfusion = (infusionName) => {
        if (infusions[infusionName]) {
          const copy = { ...infusions }; delete copy[infusionName]; setInfusions(copy);
        } else {
          setInfusions({ ...infusions, [infusionName]: true });
        }
      };

      const toggleMOUD = (moudName) => {
        const newMoud = { ...moud };
        if (newMoud[moudName]) delete newMoud[moudName];
        else newMoud[moudName] = { active: true, dose: '', route: 'oral' };
        setMoud(newMoud);
      };

      // ========== RECOMMENDATION ENGINE ==========
      const generateRecommendations = React.useMemo(() => {
        // Detect mechanisms
        const hasNociceptive = painQuality.some(q => ['Aching/Throbbing', 'Dull/Pressure'].includes(q));
        const hasNeuropathic = painQuality.some(q => ['Burning/Shooting'].includes(q));
        const hasVisceral = painQuality.some(q => ['Cramping/Colicky'].includes(q));
        let painMechanism = 'Undifferentiated';
        if (hasNeuropathic && !hasNociceptive && !hasVisceral) painMechanism = 'Neuropathic';
        else if (hasNociceptive && !hasNeuropathic && !hasVisceral) painMechanism = 'Nociceptive';
        else if (hasVisceral && !hasNeuropathic) painMechanism = 'Visceral';
        else if (painQuality.length > 1) painMechanism = 'Mixed nociceptive/neuropathic';

        // Comorbidity helpers
        const hasRenal = comorbidities.some(c => c.includes('CKD'));
        const hasSevereRenal = comorbidities.includes('CKD stage 5/dialysis');
        const hasHepatic = comorbidities.some(c => c.includes('Hepatic'));
        const hasSevereHepatic = comorbidities.includes('Hepatic impairment (severe/cirrhosis)');
        const isElderly = comorbidities.includes('Age ≥65');
        const hasOSA = comorbidities.includes('OSA');
        const hasCOPD = comorbidities.includes('COPD');
        const contraindNSAID = comorbidities.includes('Active PUD/GI bleed') || hasSevereRenal || comorbidities.includes('Thrombocytopenia') || comorbidities.includes('On anticoagulation');
        const hasNSAID = Object.keys(nonOpioids).some(k => ['Ibuprofen', 'Celecoxib', 'Naproxen'].includes(k)) || opioids.some(o => o.drug === 'Ketorolac IV');
        const hasApap = !!nonOpioids['Acetaminophen'];
        const hasGabapentinoid = Object.keys(nonOpioids).some(k => ['Gabapentin', 'Pregabalin'].includes(k));
        const hasKetaminePO = !!nonOpioids['Ketamine PO'] || opioids.some(o => o.drug === 'Ketamine PO');
        const hasKetamineInfusion = !!infusions['Ketamine infusion'];
        const hasBlock = !!infusions['Epidural'] || !!infusions['Peripheral nerve block (single shot)'] || !!infusions['Continuous nerve block catheter'];
        const activeMOUDs = Object.keys(moud).filter(k => moud[k]?.active);
        const hasMorphine = opioids.some(o => o.drug.includes('Morphine'));

        // Multimodal classes on board
        const multimodalClasses = [];
        if (hasApap) multimodalClasses.push('APAP');
        if (hasNSAID) multimodalClasses.push('NSAID');
        if (hasGabapentinoid) multimodalClasses.push('Gabapentinoid');
        if (hasKetaminePO || hasKetamineInfusion) multimodalClasses.push('Ketamine');
        if (hasBlock || !!infusions['Epidural']) multimodalClasses.push('Regional');
        if (!!infusions['Lidocaine IV infusion']) multimodalClasses.push('IV Lidocaine');
        if (!!nonOpioids['Suzetrigine']) multimodalClasses.push('Suzetrigine');
        const multimodalCount = multimodalClasses.length;

        // Scheduled vs PRN analysis
        const scheduledOpioids = opioids.filter(o => !o.frequency.includes('PRN') && MEDD_FACTORS[o.drug] > 0);
        const prnOpioids = opioids.filter(o => o.frequency.includes('PRN') && MEDD_FACTORS[o.drug] > 0);
        const hasOnlyPRN = prnOpioids.length > 0 && scheduledOpioids.length === 0 && !pca.active;

        const homeOMENum = parseFloat(homeOME) || 0;
        const delta = toleranceStatus === 'tolerant' && homeOMENum > 0 ? medd - homeOMENum : null;

        // Build structured output
        const output = {
          oneLiner: '',
          safetyAlerts: [],      // red — things that could harm the patient RIGHT NOW
          actionItems: [],       // yellow — specific orders to write
          suggestions: [],       // green — things to consider
          conversionMath: [],    // show-your-work blocks
          dischargePlan: [],     // transition & discharge thinking
          multimodalClasses,
          multimodalCount,
          painMechanism,
          delta,
        };

        // === ONE-LINER ===
        const toleranceText = toleranceStatus === 'tolerant' ? `Opioid-tolerant (home OME ${homeOMENum || '?'})` : 'Opioid-naive';
        const moudText = activeMOUDs.length > 0 ? `, on ${activeMOUDs.join('/')}` : '';
        const oudText = hasOUD && activeMOUDs.length === 0 ? ', h/o OUD (no current MOUD)' : '';
        const podText = postOpDay ? ` POD#${postOpDay}` : '';
        const condText = primaryCondition || 'acute pain';
        output.oneLiner = `${toleranceText}${moudText}${oudText} patient with ${condText}${podText}. ${painMechanism} pain NRS ${painAtRest}→${painWithActivity} (rest→activity). MEDD ${medd} OME. Control: ${controlStatus.toLowerCase()}.`;

        // === SAFETY ALERTS ===
        // High MEDD
        if (medd > 120) {
          output.safetyAlerts.push({ text: `MEDD ${medd} mg OME — very high. Naloxone at bedside, continuous SpO₂/ETCO₂. Reassess need for this dose.`, tag: 'HIGH MEDD' });
        } else if (medd > 90) {
          output.safetyAlerts.push({ text: `MEDD ${medd} mg OME — approaching high-risk threshold. Ensure continuous pulse oximetry, naloxone available.`, tag: 'HIGH MEDD' });
        }

        // Morphine in renal failure
        if (hasMorphine && hasRenal) {
          output.safetyAlerts.push({ text: `Morphine with renal impairment: active metabolite (M6G) accumulates → prolonged sedation, respiratory depression. Switch to hydromorphone or fentanyl.`, tag: 'RENAL' });
        }

        // Gabapentinoid + opioid + elderly/OSA
        if (hasGabapentinoid && opioids.length > 0 && (isElderly || hasOSA)) {
          output.safetyAlerts.push({ text: `Gabapentinoid + opioid in ${isElderly ? 'elderly' : 'OSA'} patient: additive CNS/respiratory depression. FDA boxed warning. Consider lower doses or discontinuation.`, tag: 'CNS DEP' });
        }

        // Somnolent + opioids
        if (sedationStatus === 'Somnolent' && opioids.length > 0) {
          output.safetyAlerts.push({ text: `Patient somnolent on current opioid regimen. Hold further opioid doses until reassessed. Consider dose reduction.`, tag: 'SEDATION' });
        }

        // Naltrexone + opioids ordered
        if (activeMOUDs.includes('Naltrexone') && opioids.length > 0) {
          const route = moud['Naltrexone']?.route || 'oral';
          output.safetyAlerts.push({ text: `Opioids ordered but patient on naltrexone (${route}). Opioids will be INEFFECTIVE. ${route === 'injectable' ? 'Blockade lasts ~30 days.' : 'Washout ~72h after last dose.'}`, tag: 'ANTAGONIST' });
        }

        // NSAID contraindicated but ordered
        if (contraindNSAID && hasNSAID) {
          const reasons = comorbidities.filter(c => ['Active PUD/GI bleed', 'CKD stage 5/dialysis', 'Thrombocytopenia', 'On anticoagulation'].includes(c)).join(', ');
          output.safetyAlerts.push({ text: `NSAID on board but contraindicated: ${reasons}. Discontinue.`, tag: 'NSAID CI' });
        }

        // Under-dosed tolerant patient
        if (toleranceStatus === 'tolerant' && homeOMENum > 0 && medd < homeOMENum * 0.8) {
          output.safetyAlerts.push({ text: `Current MEDD (${medd}) is ${Math.round((1 - medd/homeOMENum) * 100)}% below home baseline (${homeOMENum} OME). Risk of withdrawal and uncontrolled pain. Ensure home regimen is covered.`, tag: 'UNDER-DOSED' });
        }

        // === ACTION ITEMS (specific orders) ===

        // IV→PO conversion when tolerating PO
        const ivAnalgesicOpioids = opioids.filter(o => ['Morphine IV', 'Hydromorphone IV', 'Fentanyl IV'].includes(o.drug));
        if (ivAnalgesicOpioids.length > 0 && toleratingPO) {
          ivAnalgesicOpioids.forEach(iv => {
            const targets = hasRenal
              ? [{ drug: 'Hydromorphone PO', label: 'HM PO' }, { drug: 'Oxycodone IR', label: 'Oxy IR' }]
              : [{ drug: 'Oxycodone IR', label: 'Oxy IR' }, { drug: 'Morphine IR', label: 'Morphine IR' }, { drug: 'Hydromorphone PO', label: 'HM PO' }];

            const conversions = targets.map(t => {
              const conv = calculateEquianalgesicDose(iv.drug, parseFloat(iv.dose), iv.frequency, t.drug, 0.25);
              if (!conv) return null;
              const rounded = roundToClinic(conv.adjusted, t.drug);
              return { label: t.label, dose: rounded, drug: t.drug, math: conv.math };
            }).filter(Boolean);

            if (conversions.length > 0) {
              const options = conversions.map(c => `${c.label} ${c.dose}mg`).join(' | ');
              output.actionItems.push({
                text: `IV→PO: Convert ${iv.drug} ${iv.dose}${iv.unit} ${iv.frequency} → ${options} (same frequency)`,
                tag: 'CONVERT',
                sub: hasRenal ? 'Morphine avoided (renal). HM/oxy preferred.' : null,
              });
              conversions.forEach(c => {
                output.conversionMath.push({ label: `${iv.drug} → ${c.label}`, math: c.math });
              });
            }
          });
        }

        // Breakthrough dosing
        if (medd > 0) {
          const btOME = Math.round(medd * 0.15);
          const btMorphIV = roundToClinic(btOME / 3, 'Morphine IV');
          const btHMIV = roundToClinic(btOME / 20, 'Hydromorphone IV');
          const btOxy = roundToClinic(btOME / 1.5, 'Oxycodone IR');

          let btOptions;
          if (hasRenal) {
            btOptions = `HM ${btHMIV}mg IV Q3H PRN | Oxy IR ${btOxy}mg PO Q4H PRN`;
            output.actionItems.push({
              text: `Breakthrough (15% of MEDD = ${btOME} OME): ${btOptions}`,
              tag: 'BT DOSE',
              sub: 'Morphine avoided (renal impairment).',
            });
          } else {
            btOptions = `Morphine ${btMorphIV}mg IV Q3H PRN | HM ${btHMIV}mg IV Q3H PRN | Oxy IR ${btOxy}mg PO Q4H PRN`;
            output.actionItems.push({
              text: `Breakthrough (15% of MEDD = ${btOME} OME): ${btOptions}`,
              tag: 'BT DOSE',
            });
          }
          output.conversionMath.push({ label: 'Breakthrough calculation', math: `MEDD ${medd} × 15% = ${btOME} OME → Morphine IV: ${btOME}/3 = ${btMorphIV}mg | HM IV: ${btOME}/20 = ${btHMIV}mg | Oxy IR: ${btOME}/1.5 = ${btOxy}mg` });
        }

        // Opioid-naive starting doses
        if (toleranceStatus === 'naive' && opioids.length === 0 && controlStatus !== 'Yes' && !pca.active) {
          const doseAdj = isElderly ? ' (reduce 50% for age ≥65)' : '';
          if (toleratingPO) {
            output.actionItems.push({
              text: `Start: Oxycodone IR 5mg PO Q4H PRN${doseAdj} OR Morphine IR 5-10mg PO Q4H PRN${doseAdj}${hasRenal ? ' (prefer oxy if renal)' : ''}`,
              tag: 'START',
            });
          }
          output.actionItems.push({
            text: `Start: Morphine 2-4mg IV Q4H PRN${doseAdj} OR HM 0.2-0.4mg IV Q3H PRN${doseAdj}${hasRenal ? ' (prefer HM if renal)' : ''}`,
            tag: 'START',
            sub: 'Reassess in 15-30 min (IV) or 60 min (PO). Titrate to NRS ≤4.',
          });
        }

        // Scheduled vs PRN imbalance
        if (hasOnlyPRN && medd > 30) {
          output.actionItems.push({
            text: `Only PRN opioids on board (MEDD ${medd}). Convert to scheduled + PRN: schedule ~60-70% of daily requirement around the clock, keep 15% as breakthrough.`,
            tag: 'SCHEDULE',
            sub: 'Scheduled dosing provides more consistent analgesia, reduces pain crises, and is better for discharge planning.',
          });
        }

        // Non-opioid backbone gaps
        if (!hasApap && !hasSevereHepatic) {
          output.actionItems.push({
            text: `Add acetaminophen 1000mg PO/IV Q6H scheduled (max 3g/day${hasHepatic ? ', reduce for hepatic impairment' : ''})`,
            tag: 'MULTIMODAL',
          });
        }
        if (!hasNSAID && !contraindNSAID) {
          if (painAtRest > 6 || controlStatus === 'No') {
            output.actionItems.push({ text: `Add ketorolac 15mg IV Q6H (max 5 days)${isElderly ? ' — use 15mg not 30mg (age ≥65)' : ''}`, tag: 'MULTIMODAL' });
          } else {
            output.suggestions.push({ text: `Consider NSAID: ibuprofen 400mg PO Q6H or celecoxib 200mg PO BID`, tag: 'MULTIMODAL' });
          }
        } else if (contraindNSAID && !hasNSAID) {
          const reasons = comorbidities.filter(c => ['Active PUD/GI bleed', 'CKD stage 5/dialysis', 'Thrombocytopenia', 'On anticoagulation'].includes(c)).join(', ');
          output.suggestions.push({ text: `NSAIDs contraindicated (${reasons}). Ensure other multimodal agents maximized.`, tag: 'CI' });
        }

        // Gabapentinoid
        if (!hasGabapentinoid && (hasNeuropathic || ['Post-op general', 'Post-op spine', 'Post-op thoracic', 'Post-op vascular'].includes(primaryCondition))) {
          const renalNote = hasRenal ? ' (reduce dose for renal)' : '';
          output.actionItems.push({ text: `Add gabapentin 300mg PO TID${renalNote} or pregabalin 75mg PO BID${renalNote}`, tag: 'MULTIMODAL', sub: `${hasNeuropathic ? 'Neuropathic component identified. ' : ''}Gabapentinoids opioid-sparing; titrate over days.` });
        }

        // Ketamine PO
        if (!hasKetaminePO && (medd > 90 || (toleranceStatus === 'tolerant' && controlStatus === 'No'))) {
          output.actionItems.push({
            text: `Add ketamine PO 10-25mg Q6H (titrate to 50mg Q6H)`,
            tag: 'KETAMINE',
            sub: 'NMDA antagonist. Opioid-sparing, prevents OIH. First-line adjuvant for refractory pain in opioid-tolerant patients. PO preferred over IV for ease of transition to discharge.',
          });
        }
        if (!hasKetamineInfusion && !hasKetaminePO && (medd > 90 || (toleranceStatus === 'tolerant' && controlStatus === 'No')) && !toleratingPO) {
          output.actionItems.push({
            text: `Start ketamine infusion 0.1-0.3 mg/kg/hr (sub-anesthetic)${weight ? ` → ${Math.round(parseFloat(weight) * 0.1)}-${Math.round(parseFloat(weight) * 0.3)} mg/hr` : ''}`,
            tag: 'KETAMINE',
            sub: 'Not tolerating PO; IV ketamine appropriate. Transition to PO when able. Caution: uncontrolled HTN, psychosis, elevated ICP.',
          });
        }

        // Suzetrigine
        if (!nonOpioids['Suzetrigine'] && controlStatus === 'No' && (contraindNSAID || medd > 90 || toleranceStatus === 'tolerant')) {
          output.suggestions.push({ text: `Consider suzetrigine (Journavx) 100mg PO TID — selective Nav1.7 inhibitor, no respiratory depression, no opioid interaction`, tag: 'NOVEL' });
        }

        // Regional
        if (['Post-op ortho', 'Post-op thoracic', 'Post-op general', 'Post-op abdominal', 'Post-op vascular', 'Post-op spine', 'Trauma/fracture'].includes(primaryCondition) || consultTypes.includes('Post-surgical')) {
          const contraindBlock = comorbidities.includes('Thrombocytopenia') || comorbidities.includes('On anticoagulation');
          if (!hasBlock && !contraindBlock) {
            output.actionItems.push({ text: `Evaluate for regional analgesia (peripheral nerve block ± catheter, or epidural if appropriate)`, tag: 'REGIONAL', sub: 'Regional reduces opioid requirement 30-50%. Review anatomy and anticoagulation status.' });
          } else if (contraindBlock) {
            output.suggestions.push({ text: `Regional may be contraindicated (anticoagulation/thrombocytopenia). Review timing of last anticoagulant dose per ASRA guidelines.`, tag: 'REGIONAL' });
          }
        }

        // Lidocaine infusion
        if ((hasNeuropathic || painMechanism.includes('Mixed')) && !infusions['Lidocaine IV infusion'] && !hasBlock) {
          output.suggestions.push({ text: `Consider IV lidocaine infusion 1-1.5 mg/kg/hr${weight ? ` (${Math.round(parseFloat(weight) * 1)}-${Math.round(parseFloat(weight) * 1.5)} mg/hr)` : ''} for neuropathic component`, tag: 'ADJUVANT' });
        }

        // Dexmedetomidine
        if ((comorbidities.includes('Active delirium') || sedationStatus === 'Somnolent') && medd > 30) {
          output.suggestions.push({ text: `Consider dexmedetomidine infusion (ICU) for opioid-sparing analgesia — reduces delirium risk vs continued opioid escalation`, tag: 'ADJUVANT' });
        }

        // === MOUD-SPECIFIC ===
        activeMOUDs.forEach(moudType => {
          const dose = moud[moudType]?.dose;
          const doseText = dose ? ` ${dose}mg/day` : '';

          if (moudType === 'Buprenorphine' || moudType === 'Suboxone') {
            output.safetyAlerts.push({ text: `On ${moudType}${doseText} — DO NOT discontinue. Continue current dose, consider split dosing TID-QID for improved analgesia. Full agonist opioids may require higher doses due to partial receptor occupancy.`, tag: 'MOUD' });
            output.actionItems.push({ text: `Coordinate with addiction medicine. Add ketamine PO/infusion for NMDA-mediated adjuvant analgesia (not dependent on mu-receptor).`, tag: 'MOUD' });
          } else if (moudType === 'Methadone') {
            output.actionItems.push({ text: `Continue maintenance methadone${doseText} (verify with OTP). This is NOT analgesic dosing — supplement with multimodal + additional opioid for acute pain.`, tag: 'MOUD', sub: 'Monitor QTc. Avoid opioid rotation TO methadone without specialist input.' });
          } else if (moudType === 'Naltrexone') {
            // Already handled in safety alerts above
            output.actionItems.push({ text: `Maximize non-opioid multimodal: NSAIDs, gabapentinoids, ketamine, regional blocks. URGENT addiction medicine consult.`, tag: 'MOUD' });
          }
        });

        // OUD without MOUD
        if (hasOUD && activeMOUDs.length === 0) {
          output.suggestions.push({ text: `H/o OUD, no current MOUD. Use opioids judiciously with close monitoring. Favor scheduled over PRN. Consider addiction medicine co-management. Screen for relapse risk.`, tag: 'OUD' });
        }

        // === MONITORING ===
        if (medd > 90) {
          output.actionItems.push({ text: `Naloxone 0.4mg at bedside. Continuous SpO₂. Respiratory assessments Q1-2H.`, tag: 'SAFETY' });
        }
        if ((hasOSA || hasCOPD) && medd > 45) {
          output.actionItems.push({ text: `Continuous pulse oximetry (${hasOSA ? 'OSA' : ''}${hasOSA && hasCOPD ? '+' : ''}${hasCOPD ? 'COPD' : ''} + opioids). Consider capnography if available.`, tag: 'SAFETY' });
        }
        if (opioids.length > 0 && !nonOpioids['Senna'] && !nonOpioids['Docusate']) {
          output.actionItems.push({ text: `Bowel regimen: senna 8.6mg + docusate 100mg BID. Reassess Q48H.`, tag: 'PROPHYLAXIS' });
        }
        if (isElderly && (opioids.length > 0 || hasGabapentinoid)) {
          output.suggestions.push({ text: `Fall precautions (age ≥65 + CNS-active medications). Evaluate for polypharmacy.`, tag: 'GERI' });
        }

        // === DISCHARGE PLAN ===
        if (toleratingPO && controlStatus !== 'No') {
          if (ivAnalgesicOpioids.length > 0) {
            output.dischargePlan.push(`Transition IV→PO (see conversion above). Target stable PO regimen ×24h before discharge.`);
          }
          if (pca.active) {
            output.dischargePlan.push(`Wean PCA: convert to equivalent scheduled PO + PRN. Target PCA-free ×12-24h before discharge.`);
          }
          if (infusions['Ketamine infusion']) {
            output.dischargePlan.push(`Transition ketamine infusion → PO ketamine 10-50mg Q6H before discharge.`);
          }
          if (infusions['Lidocaine IV infusion']) {
            output.dischargePlan.push(`D/C lidocaine infusion. Consider lidocaine patch 5% or PO gabapentinoid for continued neuropathic coverage.`);
          }
        }

        if (toleranceStatus === 'tolerant' && homeOMENum > 0) {
          output.dischargePlan.push(`Resume home opioid regimen (${homeOMENum} OME). Provide PRN breakthrough for acute component with defined taper plan.`);
        } else if (toleranceStatus === 'naive' && medd > 0) {
          output.dischargePlan.push(`Opioid-naive: limit discharge prescription to ≤3-5 day supply. Include opioid-sparing multimodal regimen. Set expectations for taper.`);
        }

        if (medd > 90 || toleranceStatus === 'tolerant') {
          output.dischargePlan.push(`Prescribe naloxone (Narcan) for home. Educate patient/family on signs of overdose.`);
        }

        if (hasOUD || activeMOUDs.length > 0) {
          output.dischargePlan.push(`Ensure MOUD follow-up arranged prior to discharge. Coordinate with addiction medicine for transition plan.`);
        }

        // Methadone rotation warning
        if (opioids.some(o => o.drug === 'Methadone PO' || o.drug === 'Methadone IV')) {
          output.conversionMath.push({
            label: 'Methadone conversion (non-linear)',
            math: `Methadone uses dose-dependent ratios:\nOME ≤60 → 4:1 (morphine:methadone)\nOME 61-160 → 8:1\nOME 161-400 → 10:1\nOME >400 → 12:1\n⚠ Methadone has long/variable t½ (15-60h). Titrate slowly. Specialist input recommended.`,
          });
        }

        return output;
      }, [consultTypes, primaryCondition, postOpDay, painAtRest, painWithActivity, painQuality, controlStatus, painPattern, toleranceStatus, homeOME, hasOUD, moud, comorbidities, sedationStatus, toleratingPO, medd, opioids, nonOpioids, infusions, pca, weight]);

      // === COPY AS CONSULT NOTE ===
      const copyConsultNote = () => {
        const r = generateRecommendations;
        let note = `ACUTE PAIN SERVICE — CLINICAL DECISION SUPPORT\n`;
        note += `${'='.repeat(50)}\n\n`;
        note += `ASSESSMENT: ${r.oneLiner}\n`;
        note += `Multimodal: ${r.multimodalClasses.length > 0 ? r.multimodalClasses.join(', ') : 'None'} (${r.multimodalCount}/7 classes)\n`;
        if (r.delta !== null) note += `Home OME delta: ${r.delta > 0 ? '+' : ''}${r.delta} mg\n`;
        note += `\n`;

        if (r.safetyAlerts.length > 0) {
          note += `⚠ SAFETY ALERTS:\n`;
          r.safetyAlerts.forEach(a => { note += `  [${a.tag}] ${a.text}\n`; });
          note += `\n`;
        }

        if (r.actionItems.length > 0) {
          note += `RECOMMENDATIONS:\n`;
          r.actionItems.forEach((a, i) => {
            note += `  ${i + 1}. [${a.tag}] ${a.text}\n`;
            if (a.sub) note += `     → ${a.sub}\n`;
          });
          note += `\n`;
        }

        if (r.suggestions.length > 0) {
          note += `CONSIDER:\n`;
          r.suggestions.forEach(s => { note += `  • [${s.tag}] ${s.text}\n`; });
          note += `\n`;
        }

        if (r.conversionMath.length > 0) {
          note += `CONVERSION MATH:\n`;
          r.conversionMath.forEach(c => { note += `  ${c.label}: ${c.math}\n`; });
          note += `\n`;
        }

        if (r.dischargePlan.length > 0) {
          note += `DISCHARGE PLANNING:\n`;
          r.dischargePlan.forEach(d => { note += `  • ${d}\n`; });
          note += `\n`;
        }

        note += `---\nEducational tool. Verify all recommendations with clinical judgment and institutional protocols.\n`;
        navigator.clipboard.writeText(note);
        setCopiedNote(true);
        setTimeout(() => setCopiedNote(false), 2000);
      };

      // ========== UI COMPONENTS ==========

      const PainScoreRow = ({ value, onChange }) => (
        <div className="flex gap-1 flex-wrap">
          {Array.from({ length: 11 }, (_, i) => (
            <button key={i} onClick={() => onChange(i)}
              className={`w-8 h-8 rounded text-sm font-bold transition ${value === i ? (i <= 3 ? 'bg-green-600 text-white' : i <= 6 ? 'bg-yellow-500 text-white' : 'bg-red-600 text-white') : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
            >{i}</button>
          ))}
        </div>
      );

      const OpioidButtonGrid = ({ opioids: opioidList, title }) => (
        <div className="mb-4">
          <h3 className="font-semibold text-slate-700 mb-2 text-sm">{title}</h3>
          <div className="grid grid-cols-2 gap-1.5">
            {opioidList.map((drugObj) => (
              <div key={drugObj.name}>
                <button
                  onClick={() => {
                    if (selectedOpioidButton === drugObj.name) { setSelectedOpioidButton(null); }
                    else {
                      setSelectedOpioidButton(drugObj.name);
                      setOpioidFormUnit(drugObj.unit);
                      setOpioidFormFreq(drugObj.name === 'Fentanyl Patch' ? 'Q72H' : drugObj.name.includes('IV') ? 'Q4H PRN' : 'Q4H');
                    }
                  }}
                  className={`w-full h-10 px-2 rounded text-xs font-semibold transition flex items-center justify-center ${selectedOpioidButton === drugObj.name ? 'bg-blue-600 text-white ring-2 ring-blue-800' : 'bg-slate-100 text-slate-800 ring-1 ring-slate-300 hover:bg-slate-200'}`}
                >{drugObj.name}</button>
                {selectedOpioidButton === drugObj.name && (
                  <div className="mt-1 p-2 bg-blue-50 border border-blue-300 rounded space-y-1.5">
                    <div>
                      <label className="text-xs font-semibold text-slate-600">Dose ({drugObj.unit})</label>
                      <input type="number" value={opioidFormDose} onChange={(e) => setOpioidFormDose(e.target.value)} className="w-full border border-blue-300 rounded px-2 py-1 text-sm" autoFocus />
                    </div>
                    <div>
                      <label className="text-xs font-semibold text-slate-600">Frequency</label>
                      <select value={opioidFormFreq} onChange={(e) => setOpioidFormFreq(e.target.value)} className="w-full border border-blue-300 rounded px-2 py-1 text-sm">
                        {frequencyOptions.map(f => <option key={f} value={f}>{f}</option>)}
                      </select>
                    </div>
                    <button onClick={() => addOpioidFromButton(drugObj)} className="w-full bg-blue-600 text-white py-1 rounded text-xs font-bold hover:bg-blue-700">Add</button>
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      );

      // === INPUT TAB ===
      const InputTab = () => (
        <div className="space-y-0">
          {/* CONTEXT */}
          <div className="border-b">
            <button onClick={() => toggleInputSection('context')} className="w-full px-4 py-2.5 flex items-center justify-between bg-slate-50 hover:bg-slate-100 transition">
              <h3 className="font-semibold text-slate-800 text-sm">Context</h3>
              {expandedInputSections.context ? <ChevronUp size={18} /> : <ChevronDown size={18} />}
            </button>
            {expandedInputSections.context && (
              <div className="px-4 py-3 space-y-3">
                <div>
                  <label className="text-xs font-semibold text-slate-700 mb-1.5 block">Reason for Consult</label>
                  <div className="flex flex-wrap gap-1.5">
                    {['Post-surgical', 'Medical acute', 'Acute-on-chronic', 'Opioid management', 'Complex/refractory'].map(type => (
                      <button key={type} onClick={() => toggleConsultType(type)}
                        className={`px-2.5 py-1.5 rounded text-xs font-semibold transition ${consultTypes.includes(type) ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                      >{type}</button>
                    ))}
                  </div>
                </div>
                <div>
                  <label className="text-xs font-semibold text-slate-700 mb-1.5 block">Primary Condition</label>
                  <select value={primaryCondition} onChange={(e) => setPrimaryCondition(e.target.value)} className="w-full border border-slate-300 rounded px-3 py-1.5 text-sm">
                    <option value="">Select...</option>
                    {['Sickle cell', 'Pancreatitis', 'Trauma/fracture', 'Cancer pain', 'Post-op general', 'Post-op ortho', 'Post-op spine', 'Post-op thoracic', 'Post-op abdominal', 'Post-op vascular', 'Burns', 'Other'].map(c => <option key={c} value={c}>{c}</option>)}
                  </select>
                </div>
                <div className="flex gap-3">
                  <div className="flex-1">
                    <label className="text-xs font-semibold text-slate-700 mb-1.5 block">POD / Hospital Day</label>
                    <input type="number" value={postOpDay} onChange={(e) => setPostOpDay(e.target.value)} className="w-full border border-slate-300 rounded px-3 py-1.5 text-sm" placeholder="e.g., 1" />
                  </div>
                  <div className="flex-1">
                    <label className="text-xs font-semibold text-slate-700 mb-1.5 block">Tolerating PO?</label>
                    <div className="flex gap-3 pt-1">
                      {[true, false].map(v => (
                        <label key={String(v)} className="flex items-center">
                          <input type="radio" name="po" checked={toleratingPO === v} onChange={() => setToleratingPO(v)} className="mr-1.5" />
                          <span className="text-sm">{v ? 'Yes' : 'No'}</span>
                        </label>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* PAIN */}
          <div className="border-b">
            <button onClick={() => toggleInputSection('pain')} className="w-full px-4 py-2.5 flex items-center justify-between bg-slate-50 hover:bg-slate-100 transition">
              <h3 className="font-semibold text-slate-800 text-sm">Pain Assessment</h3>
              {expandedInputSections.pain ? <ChevronUp size={18} /> : <ChevronDown size={18} />}
            </button>
            {expandedInputSections.pain && (
              <div className="px-4 py-3 space-y-3">
                <div>
                  <label className="text-xs font-semibold text-slate-700 mb-1.5 block">NRS at Rest</label>
                  <PainScoreRow value={painAtRest} onChange={setPainAtRest} />
                </div>
                <div>
                  <label className="text-xs font-semibold text-slate-700 mb-1.5 block">NRS with Activity</label>
                  <PainScoreRow value={painWithActivity} onChange={setPainWithActivity} />
                </div>
                <div>
                  <label className="text-xs font-semibold text-slate-700 mb-1.5 block">Pain Quality</label>
                  <div className="flex flex-wrap gap-1.5">
                    {qualityOptions.map(q => (
                      <button key={q} onClick={() => painQuality.includes(q) ? setPainQuality(painQuality.filter(pq => pq !== q)) : setPainQuality([...painQuality, q])}
                        className={`px-2.5 py-1.5 rounded text-xs font-semibold transition ${painQuality.includes(q) ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                      >{q}</button>
                    ))}
                  </div>
                </div>
                <div className="flex gap-4">
                  <div>
                    <label className="text-xs font-semibold text-slate-700 mb-1.5 block">Controlled?</label>
                    <div className="flex gap-2">
                      {['Yes', 'Partial', 'No'].map(s => (
                        <button key={s} onClick={() => setControlStatus(s)}
                          className={`px-3 py-1.5 rounded text-xs font-semibold transition ${controlStatus === s ? (s === 'Yes' ? 'bg-green-600 text-white' : s === 'Partial' ? 'bg-yellow-500 text-white' : 'bg-red-600 text-white') : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                        >{s}</button>
                      ))}
                    </div>
                  </div>
                  <div>
                    <label className="text-xs font-semibold text-slate-700 mb-1.5 block">Pattern</label>
                    <div className="flex gap-2">
                      {['Constant', 'Intermittent', 'Movement'].map(p => (
                        <button key={p} onClick={() => setPainPattern(p)}
                          className={`px-3 py-1.5 rounded text-xs font-semibold transition ${painPattern === p ? 'bg-slate-700 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                        >{p}</button>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* MEDICATIONS */}
          <div className="border-b">
            <button onClick={() => toggleInputSection('meds')} className="w-full px-4 py-2.5 flex items-center justify-between bg-slate-50 hover:bg-slate-100 transition">
              <h3 className="font-semibold text-slate-800 text-sm">Current Medications</h3>
              {expandedInputSections.meds ? <ChevronUp size={18} /> : <ChevronDown size={18} />}
            </button>
            {expandedInputSections.meds && (
              <div className="px-4 py-3 space-y-4">
                {/* MEDD Badge */}
                {medd > 0 && (
                  <button onClick={() => setShowMEDDBreakdown(!showMEDDBreakdown)}
                    className={`w-full p-2.5 rounded-lg font-bold text-white text-center text-base ${medd > 120 ? 'bg-red-700' : medd > 90 ? 'bg-red-600' : medd > 50 ? 'bg-orange-600' : 'bg-blue-600'}`}>
                    MEDD: {medd} mg OME {generateRecommendations.delta !== null && <span className="text-sm font-normal opacity-90">({generateRecommendations.delta > 0 ? '+' : ''}{generateRecommendations.delta} from home)</span>}
                    <span className="text-xs block opacity-75 mt-0.5">(tap for breakdown)</span>
                  </button>
                )}

                {/* MEDD Breakdown */}
                {showMEDDBreakdown && medd > 0 && (
                  <div className="math-block text-xs space-y-1">
                    {meddResult.breakdown.map((b, i) => (
                      <div key={i}>{b.drug}: {b.dose}{b.drug.includes('Fentanyl') ? 'mcg' : 'mg'} {b.freq} × {b.factor} = {b.ome} OME{b.note ? ` (${b.note})` : ''}</div>
                    ))}
                    {meddResult.pcaDetail && (
                      <div>PCA {meddResult.pcaDetail.drug}: {meddResult.pcaDetail.note} × {meddResult.pcaDetail.factor} = {meddResult.pcaDetail.ome} OME</div>
                    )}
                    <div className="font-bold border-t border-slate-300 pt-1">Total: {medd} OME/day</div>
                  </div>
                )}

                {/* Active Medications List */}
                {opioids.length > 0 && (
                  <div>
                    <p className="section-label">Active Opioids</p>
                    <div className="space-y-1">
                      {opioids.map((med, idx) => (
                        <div key={idx} className="flex items-center justify-between bg-slate-100 px-2 py-1.5 rounded text-xs">
                          <span><span className="font-semibold">{med.drug}</span> {med.dose}{med.unit} {med.frequency}</span>
                          <button onClick={() => removeOpioid(idx)} className="text-red-500 hover:text-red-700 p-0.5"><X size={14} /></button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                <OpioidButtonGrid opioids={ivOpioids} title="IV Opioids" />

                {/* PCA */}
                <div className="border-t pt-3">
                  <div className="flex items-center justify-between mb-2">
                    <h4 className="font-semibold text-slate-700 text-sm">PCA</h4>
                    <button onClick={() => setPCA({ ...pca, active: !pca.active })}
                      className={`px-3 py-1 rounded text-xs font-bold transition ${pca.active ? 'bg-purple-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                    >{pca.active ? 'Active' : 'Inactive'}</button>
                  </div>
                  {pca.active && (
                    <div className="bg-purple-50 border border-purple-200 rounded p-3 space-y-2">
                      <div>
                        <label className="text-xs font-semibold text-slate-600 block mb-1">Drug</label>
                        <div className="flex gap-3">
                          {['Hydromorphone', 'Morphine', 'Fentanyl'].map(drug => (
                            <label key={drug} className="flex items-center"><input type="radio" name="pcaDrug" value={drug} checked={pca.drug === drug} onChange={(e) => setPCA({ ...pca, drug: e.target.value })} className="mr-1" /><span className="text-xs">{drug}</span></label>
                          ))}
                        </div>
                      </div>
                      <div className="grid grid-cols-3 gap-2">
                        <div>
                          <label className="text-xs font-semibold text-slate-600 block">Demand ({pca.drug === 'Fentanyl' ? 'mcg' : 'mg'})</label>
                          <input type="number" value={pca.demandDose} onChange={(e) => setPCA({ ...pca, demandDose: e.target.value })} placeholder="0.2" className="w-full border border-purple-200 rounded px-2 py-1 text-sm" />
                        </div>
                        <div>
                          <label className="text-xs font-semibold text-slate-600 block">Lockout (min)</label>
                          <input type="number" value={pca.lockout} onChange={(e) => setPCA({ ...pca, lockout: e.target.value })} placeholder="6" className="w-full border border-purple-200 rounded px-2 py-1 text-sm" />
                        </div>
                        <div>
                          <label className="text-xs font-semibold text-slate-600 block">Basal ({pca.drug === 'Fentanyl' ? 'mcg' : 'mg'}/hr)</label>
                          <input type="number" value={pca.basalRate} onChange={(e) => setPCA({ ...pca, basalRate: e.target.value })} placeholder="0" className="w-full border border-purple-200 rounded px-2 py-1 text-sm" />
                        </div>
                      </div>
                    </div>
                  )}
                </div>

                <OpioidButtonGrid opioids={poOpioids} title="PO Opioids" />
                <OpioidButtonGrid opioids={otherRouteOpioids} title="Other Routes" />

                {/* Non-Opioids */}
                <div className="pt-3 border-t">
                  <p className="section-label">Non-Opioid Analgesics</p>
                  <div className="flex flex-wrap gap-1.5">
                    {nonOpioidDrugs.map(drug => (
                      <button key={drug.name} onClick={() => toggleNonOpioid(drug.name)}
                        className={`px-2.5 py-1.5 rounded text-xs font-semibold transition ${nonOpioids[drug.name] ? 'bg-green-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                      >{drug.name}</button>
                    ))}
                  </div>
                </div>

                {/* Infusions */}
                <div className="pt-3 border-t">
                  <p className="section-label">Infusions / Interventional</p>
                  <div className="flex flex-wrap gap-1.5">
                    {infusionDrugs.map(inf => (
                      <button key={inf} onClick={() => toggleInfusion(inf)}
                        className={`px-2.5 py-1.5 rounded text-xs font-semibold transition ${infusions[inf] ? 'bg-purple-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                      >{inf}</button>
                    ))}
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* PATIENT FACTORS */}
          <div className="border-b">
            <button onClick={() => toggleInputSection('factors')} className="w-full px-4 py-2.5 flex items-center justify-between bg-slate-50 hover:bg-slate-100 transition">
              <h3 className="font-semibold text-slate-800 text-sm">Patient Factors</h3>
              {expandedInputSections.factors ? <ChevronUp size={18} /> : <ChevronDown size={18} />}
            </button>
            {expandedInputSections.factors && (
              <div className="px-4 py-3 space-y-3">
                <div className="flex gap-4">
                  <div>
                    <label className="text-xs font-semibold text-slate-700 mb-1.5 block">Tolerance</label>
                    <div className="flex gap-2">
                      {['naive', 'tolerant'].map(s => (
                        <button key={s} onClick={() => setToleranceStatus(s)}
                          className={`px-3 py-1.5 rounded text-xs font-semibold transition ${toleranceStatus === s ? 'bg-slate-700 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                        >{s === 'naive' ? 'Naive' : 'Tolerant'}</button>
                      ))}
                    </div>
                  </div>
                  {toleranceStatus === 'tolerant' && (
                    <div className="flex-1">
                      <label className="text-xs font-semibold text-slate-700 mb-1.5 block">Home OME (mg/day)</label>
                      <input type="number" value={homeOME} onChange={(e) => setHomeOME(e.target.value)} className="w-full border border-slate-300 rounded px-3 py-1.5 text-sm" placeholder="e.g., 60" />
                    </div>
                  )}
                </div>

                <div className="flex gap-4 items-start">
                  <div>
                    <label className="flex items-center gap-2">
                      <input type="checkbox" checked={hasOUD} onChange={(e) => setHasOUD(e.target.checked)} />
                      <span className="text-xs font-semibold text-slate-700">H/o OUD</span>
                    </label>
                  </div>
                  <div className="flex-1">
                    <label className="text-xs font-semibold text-slate-700 mb-1.5 block">MOUD</label>
                    <div className="flex flex-wrap gap-1.5">
                      {['Methadone', 'Buprenorphine', 'Suboxone', 'Naltrexone'].map(m => (
                        <button key={m} onClick={() => toggleMOUD(m)}
                          className={`px-2.5 py-1 rounded text-xs font-semibold transition ${moud[m]?.active ? 'bg-amber-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                        >{m}</button>
                      ))}
                    </div>
                  </div>
                </div>

                {/* MOUD dose inputs */}
                {Object.keys(moud).filter(k => moud[k]?.active).map(moudName => (
                  <div key={moudName} className="ml-4 bg-amber-50 p-2 rounded border border-amber-200">
                    {moudName === 'Naltrexone' ? (
                      <div className="flex gap-3">
                        <span className="text-xs font-semibold">{moudName}:</span>
                        {['oral', 'injectable'].map(route => (
                          <label key={route} className="flex items-center"><input type="radio" name="naltrexone_route" value={route} checked={(moud[moudName]?.route || 'oral') === route} onChange={(e) => setMoud({ ...moud, [moudName]: { ...moud[moudName], route: e.target.value } })} className="mr-1" /><span className="text-xs">{route === 'oral' ? 'PO 50mg daily' : 'IM (Vivitrol) monthly'}</span></label>
                        ))}
                      </div>
                    ) : (
                      <div className="flex items-center gap-2">
                        <span className="text-xs font-semibold">{moudName} dose:</span>
                        <input type="number" value={moud[moudName]?.dose || ''} onChange={(e) => setMoud({ ...moud, [moudName]: { ...moud[moudName], dose: e.target.value } })} className="w-20 border border-amber-300 rounded px-2 py-0.5 text-xs" placeholder="mg/day" />
                        <span className="text-xs text-slate-500">mg/day</span>
                      </div>
                    )}
                  </div>
                ))}

                {/* Comorbidities */}
                <div>
                  <label className="text-xs font-semibold text-slate-700 mb-1.5 block">Comorbidities</label>
                  <div className="grid grid-cols-2 gap-1 text-xs">
                    {['Age ≥65', 'AKI', 'CKD stage 3-4', 'CKD stage 5/dialysis', 'Hepatic impairment (mild-moderate)', 'Hepatic impairment (severe/cirrhosis)', 'OSA', 'COPD', 'CAD/recent MI', 'Heart failure', 'Active PUD/GI bleed', 'Thrombocytopenia', 'On anticoagulation', 'Active delirium', 'Dementia', 'Seizure disorder'].map(c => (
                      <label key={c} className="flex items-center py-0.5">
                        <input type="checkbox" checked={comorbidities.includes(c)} onChange={(e) => e.target.checked ? setComorbidities([...comorbidities, c]) : setComorbidities(comorbidities.filter(x => x !== c))} className="mr-1.5" />
                        <span>{c}</span>
                      </label>
                    ))}
                  </div>
                </div>

                <div className="flex gap-4">
                  <div>
                    <label className="text-xs font-semibold text-slate-700 mb-1.5 block">Sedation</label>
                    <div className="flex gap-2">
                      {['Alert', 'Drowsy', 'Somnolent'].map(s => (
                        <button key={s} onClick={() => setSedationStatus(s)}
                          className={`px-2.5 py-1 rounded text-xs font-semibold transition ${sedationStatus === s ? (s === 'Alert' ? 'bg-green-600 text-white' : s === 'Drowsy' ? 'bg-yellow-500 text-white' : 'bg-red-600 text-white') : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                        >{s}</button>
                      ))}
                    </div>
                  </div>
                  <div>
                    <label className="text-xs font-semibold text-slate-700 mb-1.5 block">Weight (kg)</label>
                    <input type="number" value={weight} onChange={(e) => setWeight(e.target.value)} className="w-20 border border-slate-300 rounded px-2 py-1 text-sm" placeholder="kg" />
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );

      // === RECOMMENDATIONS TAB ===
      const RecommendationsTab = () => {
        const r = generateRecommendations;
        const totalRecs = r.safetyAlerts.length + r.actionItems.length + r.suggestions.length;
        return (
          <div className="space-y-4 pb-6">
            {/* One-liner */}
            <div className="bg-slate-800 text-white p-3 rounded-lg">
              <p className="text-sm leading-relaxed">{r.oneLiner}</p>
              <div className="flex gap-2 mt-2 flex-wrap">
                <span className={`badge ${r.multimodalCount >= 4 ? 'bg-green-700' : r.multimodalCount >= 2 ? 'bg-yellow-600' : 'bg-red-600'}`}>
                  {r.multimodalCount}/7 multimodal
                </span>
                {r.delta !== null && (
                  <span className={`badge ${r.delta > 0 ? 'bg-blue-600' : r.delta < 0 ? 'bg-red-600' : 'bg-slate-500'}`}>
                    {r.delta > 0 ? '+' : ''}{r.delta} from home
                  </span>
                )}
                {r.multimodalClasses.length > 0 && (
                  <span className="badge bg-slate-600">{r.multimodalClasses.join(' · ')}</span>
                )}
              </div>
            </div>

            {/* Safety Alerts */}
            {r.safetyAlerts.length > 0 && (
              <div>
                <p className="section-label text-red-700">Safety Alerts ({r.safetyAlerts.length})</p>
                {r.safetyAlerts.map((a, i) => (
                  <div key={i} className="rec-card bg-red-50 border-l-4 border-red-600 p-2.5 rounded-r mb-1.5">
                    <div className="flex items-start gap-2">
                      <span className="badge bg-red-600 text-white flex-shrink-0 mt-0.5">{a.tag}</span>
                      <p className="text-xs text-red-900 leading-relaxed">{a.text}</p>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* Action Items */}
            {r.actionItems.length > 0 && (
              <div>
                <p className="section-label">Recommendations ({r.actionItems.length})</p>
                {r.actionItems.map((a, i) => (
                  <div key={i} className="rec-card bg-white border-l-4 border-blue-500 p-2.5 rounded-r mb-1.5 shadow-sm">
                    <div className="flex items-start gap-2">
                      <span className="badge bg-blue-100 text-blue-700 flex-shrink-0 mt-0.5">{a.tag}</span>
                      <div>
                        <p className="text-xs text-slate-900 font-semibold leading-relaxed">{a.text}</p>
                        {a.sub && <p className="text-xs text-slate-500 mt-0.5 leading-relaxed">{a.sub}</p>}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* Suggestions */}
            {r.suggestions.length > 0 && (
              <div>
                <p className="section-label">Consider ({r.suggestions.length})</p>
                {r.suggestions.map((s, i) => (
                  <div key={i} className="rec-card bg-green-50 border-l-4 border-green-500 p-2.5 rounded-r mb-1.5">
                    <div className="flex items-start gap-2">
                      <span className="badge bg-green-100 text-green-700 flex-shrink-0 mt-0.5">{s.tag}</span>
                      <p className="text-xs text-green-900 leading-relaxed">{s.text}</p>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* Conversion Math */}
            {r.conversionMath.length > 0 && (
              <div>
                <p className="section-label">Show Your Work</p>
                {r.conversionMath.map((c, i) => (
                  <div key={i} className="mb-2">
                    <p className="text-xs font-semibold text-slate-700">{c.label}</p>
                    <div className="math-block">{c.math}</div>
                  </div>
                ))}
              </div>
            )}

            {/* Discharge Plan */}
            {r.dischargePlan.length > 0 && (
              <div>
                <p className="section-label text-indigo-700">Discharge Planning</p>
                <div className="bg-indigo-50 border border-indigo-200 rounded p-3 space-y-1.5">
                  {r.dischargePlan.map((d, i) => (
                    <p key={i} className="text-xs text-indigo-900 leading-relaxed">• {d}</p>
                  ))}
                </div>
              </div>
            )}

            {/* Copy Button */}
            <button onClick={copyConsultNote}
              className={`w-full py-2.5 rounded font-semibold flex items-center justify-center gap-2 text-sm transition ${copiedNote ? 'bg-green-600 text-white' : 'bg-slate-800 text-white hover:bg-slate-700'}`}>
              <Copy size={16} /> {copiedNote ? 'Copied to clipboard' : 'Copy as Consult Note'}
            </button>
          </div>
        );
      };

      // === LAYOUT ===
      const [screenWidth, setScreenWidth] = React.useState(typeof window !== 'undefined' ? window.innerWidth : 1024);
      React.useEffect(() => {
        const handleResize = () => setScreenWidth(window.innerWidth);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);
      const wide = screenWidth >= 1024;
      const totalRecs = generateRecommendations.safetyAlerts.length + generateRecommendations.actionItems.length + generateRecommendations.suggestions.length;

      return (
        <div className="min-h-screen bg-slate-100">
          <div className="bg-red-700 text-white text-xs text-center py-1.5 font-semibold no-print">
            Educational Tool — Verify with clinical judgment and institutional protocols
          </div>
          <div className="bg-slate-800 text-white px-4 py-3 flex items-center justify-between no-print">
            <div>
              <h1 className="text-lg font-bold">APS Decision Support</h1>
              <p className="text-xs text-slate-400">Acute Pain Service</p>
            </div>
            <button onClick={resetAll} className="bg-slate-600 hover:bg-slate-500 text-white text-xs font-semibold px-3 py-1.5 rounded transition">Reset</button>
          </div>

          {medd > 0 && (
            <div className={`mx-4 mt-3 p-2.5 rounded-lg font-bold text-white text-center ${medd > 120 ? 'bg-red-700' : medd > 90 ? 'bg-red-600' : medd > 50 ? 'bg-orange-600' : 'bg-blue-600'} no-print`}>
              MEDD: {medd} mg OME
              {generateRecommendations.delta !== null && <span className="text-sm font-normal ml-2">({generateRecommendations.delta > 0 ? '+' : ''}{generateRecommendations.delta} vs home)</span>}
              {generateRecommendations.safetyAlerts.length > 0 && <span className="ml-2 text-xs bg-white bg-opacity-20 px-2 py-0.5 rounded-full">{generateRecommendations.safetyAlerts.length} alert{generateRecommendations.safetyAlerts.length > 1 ? 's' : ''}</span>}
            </div>
          )}

          <div className="p-3 max-w-7xl mx-auto">
            {wide ? (
              <div className="grid grid-cols-2 gap-3" style={{ minHeight: 'calc(100vh - 160px)' }}>
                <div className="bg-white rounded-lg shadow overflow-y-auto" style={{ maxHeight: 'calc(100vh - 170px)' }}><InputTab /></div>
                <div className="bg-white rounded-lg shadow p-4 overflow-y-auto" style={{ maxHeight: 'calc(100vh - 170px)' }}><RecommendationsTab /></div>
              </div>
            ) : (
              <div className="bg-white rounded-lg shadow overflow-hidden mb-20">
                <div className={activeTab === 'input' ? 'block' : 'hidden'}><InputTab /></div>
                <div className={activeTab === 'recs' ? 'block p-4' : 'hidden'}><RecommendationsTab /></div>
              </div>
            )}
          </div>

          {!wide && (
            <div className="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg flex no-print">
              <button onClick={() => setActiveTab('input')}
                className={`flex-1 py-3 text-sm font-semibold transition ${activeTab === 'input' ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-700'}`}>
                Input
              </button>
              <button onClick={() => setActiveTab('recs')}
                className={`flex-1 py-3 text-sm font-semibold transition relative ${activeTab === 'recs' ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-700'}`}>
                Recs
                {totalRecs > 0 && (
                  <span className={`absolute top-1.5 right-4 text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center ${generateRecommendations.safetyAlerts.length > 0 ? 'bg-red-500 text-white' : 'bg-blue-500 text-white'}`}>{totalRecs}</span>
                )}
              </button>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(AcutePainDSS));
  </script>
</body>
</html>
